<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>網站管理後台 - hhhzv523</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        .box { max-width: 600px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; }
        button { cursor: pointer; border: none; border-radius: 8px; font-weight: bold; padding: 12px; transition: 0.2s; }
        .btn-black { background: #202124; color: white; width: 100%; }
        .btn-blue { background: #1a73e8; color: white; width: 100%; font-size: 16px; margin-top: 15px; }
        .btn-add { background: #34a853; color: white; padding: 8px 15px; }
        .btn-del { background: #ea4335; color: white; width: 40px; margin-left: 5px; }
        #editor { display: none; }
        .v-item { display: flex; margin-bottom: 8px; background: #f8f9fa; padding: 8px; border-radius: 6px; }
        #msg { text-align: center; font-weight: bold; margin-top: 10px; }
        label { display: block; margin-top: 10px; font-size: 14px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="box" id="login">
        <h2>身分驗證</h2>
        <input type="password" id="pw" placeholder="輸入管理密碼">
        <button class="btn-black" onclick="login()">登入</button>
    </div>

    <div class="box" id="editor">
        <h2>網站編輯器</h2>
        <label>網站標題</label><input type="text" id="t">
        <label>圖片上傳</label><input type="file" id="f" accept="image/*"><input type="hidden" id="imgData">
        <label>介紹內容</label><textarea id="c" rows="4"></textarea>
        <label>按鈕文字</label><input type="text" id="bt">
        <label>按鈕連結</label><input type="text" id="bl">
        <label>影片清單 (YouTube/TikTok)</label>
        <div id="v-list"></div>
        <button class="btn-add" onclick="addV()">＋ 新增影片</button>
        <button class="btn-blue" onclick="save()">儲存並發佈</button>
        <p id="msg"></p>
    </div>

    <script>
        // --- 設定區 ---
        const USER = "hhhzv523"; 
        const REPO = "web";
        const FILE = "data.json";
        const MY_PASSWORD = "Ai20150325"; // 你設定的登入密碼
        const MY_TOKEN = "你的GitHub_PAT_Token直接貼在這裡"; // 請將 ghp_... 完整貼上

        // 登入邏輯 (純比對)
        function login() {
            const inputPw = document.getElementById('pw').value;
            if (inputPw === MY_PASSWORD) {
                document.getElementById('login').style.display = 'none';
                document.getElementById('editor').style.display = 'block';
                loadData();
            } else {
                alert("密碼錯誤！");
            }
        }

        // 動態新增影片
        function addV(val = "") {
            const div = document.createElement('div');
            div.className = "v-item";
            div.innerHTML = `<input type="text" class="v-url" value="${val}" style="margin:0"><button class="btn-del" onclick="this.parentElement.remove()">✕</button>`;
            document.getElementById('v-list').appendChild(div);
        }

        // 圖片處理
        document.getElementById('f').onchange = (e) => {
            const r = new FileReader();
            r.onload = () => document.getElementById('imgData').value = r.result;
            r.readAsDataURL(e.target.files[0]);
        };

        // 載入資料
        async function loadData() {
            try {
                const res = await fetch(`./${FILE}?t=${Date.now()}`);
                const d = await res.json();
                document.getElementById('t').value = d.title || "";
                document.getElementById('c').value = d.content || "";
                document.getElementById('imgData').value = d.img || "";
                document.getElementById('bt').value = d.btnText || "";
                document.getElementById('bl').value = d.btnLink || "";
                (d.videoList || []).forEach(url => addV(url));
            } catch(e) { console.log("初始化資料..."); }
        }

        // 儲存資料
        async function save() {
            const m = document.getElementById('msg');
            m.style.color = "blue";
            m.innerText = "⏳ 正在發佈到 GitHub...";
            
            try {
                // 取得現有檔案的 SHA
                const fRes = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${FILE}`);
                const fData = await fRes.json();

                const payload = {
                    title: document.getElementById('t').value,
                    content: document.getElementById('c').value,
                    img: document.getElementById('imgData').value,
                    btnText: document.getElementById('bt').value,
                    btnLink: document.getElementById('bl').value,
                    videoList: Array.from(document.querySelectorAll('.v-url')).map(i => i.value).filter(v => v !== "")
                };

                const res = await fetch(`https://api.github.com/repos/${USER}/${REPO}/contents/${FILE}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${MY_TOKEN}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: "web update",
                        content: btoa(unescape(encodeURIComponent(JSON.stringify(payload, null, 2)))),
                        sha: fData.sha
                    })
                });

                if (res.ok) {
                    m.style.color = "green";
                    m.innerText = "✅ 發佈成功！約 30 秒後生效。";
                } else {
                    m.style.color = "red";
                    m.innerText = "❌ 失敗，請檢查 Token 是否正確。";
                }
            } catch(e) {
                m.style.color = "red";
                m.innerText = "❌ 發生錯誤，請稍後再試。";
            }
        }
    </script>
</body>
</html>
